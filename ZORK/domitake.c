#include <stdio.h>

/* defines, enums ------------------------------------------------------------- */

#define NUM_OBJECTS  80

#define INSIDE  2048

#define O_YOU 1
#define O_SWORD  61
#define O_WATER 14
#define O_HOT_BELL 19
#define O_BOTTLE 28
#define O_RUSTY_KNIFE 51
#define O_LOWERED_BASKET 7
#define O_RAISED_BASKET 8
#define O_INFLATED_BOAT 39
#define O_SCEPTRE 23
#define O_KNIFE 33
#define O_AXE 21
#define O_STILETTO 60
#define O_PUNCTURED_BOAT 45
#define O_INFLATED_BOAT 39
#define O_LEAVES 44
#define O_BELL 18
#define O_CANDLES 42
#define O_BAUBLE 74
#define O_POT_OF_GOLD 48
#define O_BOOK 20
#define O_GHOSTS 3
#define O_ADVERTISEMENT 38
#define O_MATCH 40
#define O_MAP 62
#define O_BOAT_LABEL 63
#define O_TUBE 67
#define O_OWNERS_MANUAL 69
#define O_EGG 72
#define O_BROKEN_EGG 73
#define O_LUNCH 17
#define O_GARLIC 26
#define O_TUBE 67
#define O_PUTTY 68
#define O_SANDWICH_BAG 24
#define O_LAMP 36
#define O_GUIDE 65
#define O_CYCLOPS 2
#define O_BAT 4
#define O_THIEF 5
#define O_TROLL 6
#define O_TROPHY_CASE 9
#define O_MACHINE 10
#define O_MAILBOX 11
#define O_KITCHEN_TABLE 12
#define O_ATTIC_TABLE 13
#define O_ROPE 50
#define O_CHALICE 25
#define O_LARGE_BAG 59
#define O_TOOL_CHEST 53

#define R_FOREST_1 6
#define R_FOREST_2 7
#define R_FOREST_3 9
#define R_PATH 10 
#define R_UP_A_TREE 11
#define R_ENTRANCE_TO_HADES 66
#define R_WEST_OF_HOUSE 1
#define R_NORTH_OF_HOUSE 3
#define R_SOUTH_OF_HOUSE 4
#define R_EAST_OF_HOUSE 5
#define R_GRATING_CLEARING 12
#define R_CLEARING 13
#define R_LIVING_ROOM 16
#define R_TREASURE_ROOM 44
#define R_SHAFT_ROOM 97
#define R_LOWER_SHAFT 104
#define R_MAINTENANCE_ROOM 76
#define R_DAM_ROOM 74
#define R_GRATING_ROOM 36
#define R_ARAGAIN_FALLS 88
#define R_ON_RAINBOW 89
#define R_END_OF_RAINBOW 90
#define R_MIRROR_R_1 50
#define R_MIRROR_R_2 51
#define R_KITCHEN 14
#define R_CELLAR 17
#define R_MINE_4 109
#define R_SLIDE_ROOM 110
#define R_ATTIC 15
#define R_RESERVOIR_NORTH 47
#define R_NORTH_TEMPLE 72

#define BL0 233 /* (256-23) */
#define BL9 242
#define BLA 243

/*object bit flags*/

#define PROP_OPENABLE        1
#define PROP_OPEN            2
#define PROP_LIT             4
#define PROP_NODESC          8
#define PROP_NOTTAKEABLE    16
#define PROP_MOVEDDESC      32  /* set when object is first taken */
#define PROP_WEAPON        512
#define PROP_TOOL         2048
#define PROP_EVERYWHERE    256

/*room properties bit flags*/
#define R_DESCRIBED     1  /* set when room description already printed */
#define R_BODYOFWATER   2
#define R_LIT           4  /* set when there is natural light or a light fixture */
#define R_WATERHERE     8

/*fixed (unmoving) objects*/
enum
{
  F_SCENERY_VIS = 2048, /*some anonymous scenery object, visible*/
  F_SCENERY_NOTVIS,     /*                               not visible*/
  F_NOTVIS,             /*fixed object not visible*/
  F_AMB                /*amibiguous (ask for clarification)*/
};

enum
{
  VILLAIN_TROLL,
  VILLAIN_THIEF,
  VILLAIN_CYCLOPS,

  NUM_VILLAINS
};

#define F_TRAP_DOOR 2069
#define F_KITCHEN_WINDOW 2058 

#define MAX_INVENTORY_ITEMS  7
#define INV_LIMIT_CHANCE     8

#define LOAD_MAX  100

/* extern data structures ---------------------------------------------------------- */

struct OBJ_STRUCT
{
  unsigned short init_loc;
  unsigned short loc;
  unsigned short size;
  unsigned short capacity;
  unsigned short order;
  unsigned short prop;
  unsigned char init_thiefvalue;
  unsigned char thiefvalue;
};
extern struct OBJ_STRUCT Obj[];

struct ROOM_STRUCT
{
  char *scenery;
  unsigned short prop;
  unsigned short init_prop;
};
extern struct ROOM_STRUCT Room[];

extern FILE *InputStream;
extern int ItObj, PrevItObj; /*the obj "it" refers to*/
extern char TimePassed; /*flag: time passed during action*/

extern unsigned char RugMoved;
extern unsigned char TrapOpen;
extern unsigned char ExitFound; /* set this when player finds an exit from dungeon other than the trapdoor*/
extern unsigned char KitchenWindowOpen;
extern unsigned char GratingRevealed;
extern unsigned char GratingUnlocked;
extern unsigned char GratingOpen;
extern unsigned char GatesButton;
extern unsigned char RainbowSolid;
extern unsigned char MirrorBroken; /* set NotLucky too*/
extern unsigned char RopeTiedToRail;
extern unsigned char SpiritsBanished;
extern unsigned char YouAreInBoat;
extern unsigned char NotLucky;
extern unsigned char SongbirdSang;

extern int LampTurnsLeft;
extern int MatchesLeft;
extern int MaintenanceWaterLevel;
extern int BellRungCountdown; /* these three are for ceremony*/
extern int CandlesLitCountdown;
extern int BellHotCountdown;
extern int CyclopsState; /* 0: default  1: hungry  2: thirsty  3: asleep  4: fled*/
extern int ThiefDescType; /* 0: default  1: unconscious*/

extern int LoadAllowed;
extern unsigned char VillainAttacking[];

/* extern functions ---------------------------------------------------------------- */
void PrintText(char *p);
void PrintLine(char *p);
void PrintNewLine(void);
void PrintCompText(char *comp_text);
void PrintCompLine(char *);
int IsObjVisible(int obj);

short xrnd(void);

void ReturnOverlay0(short);

/* variables ----------------------------------------------------------------------- */
/* code ---------------------------------------------------------------------------- */
int GetRandom(int Range)
{
  long tmp;

  tmp = xrnd() * Range;

  return ((int)(tmp >> 16));
}

/* returns 1 if event of x% chance occurred*/
/* second parameter is used instead if it is >=0 and you're not lucky*/
int PercentChance(int x, int x_not_lucky)
{
  if (NotLucky && x_not_lucky >= 0) x = x_not_lucky;

  if (GetRandom(100) < x) return 1;
  else return 0;
}

/*returns number of objects in location*/
/*location can be a room, player's inventory, or inside object*/
int GetNumObjectsInLocation(int loc)
{
  int count, i, obj;

  count = 0;
  for (i=2; i<NUM_OBJECTS; i++)
  {
    obj = Obj[i].order;
    if (Obj[obj].loc == loc) count++;
  }
  return count;
}

/*returns total size of objects in location*/
/*location can be a room, player's inventory, or inside object*/
int GetTotalSizeInLocation(int loc)
{
  int size, i, obj;

  size = 0;
  for (i=2; i<NUM_OBJECTS; i++)
  {
    obj = Obj[i].order;
    if (Obj[obj].loc == loc) size += Obj[obj].size;
  }
  return size;
}

/*move order of "obj" to last in printing order*/
void MoveObjOrderToLast(int obj)
{
  int i, j;

  for (i=2; i<NUM_OBJECTS; i++)
    if (obj == Obj[i].order)
  {
    for (j=i; j<NUM_OBJECTS-1; j++)
      Obj[j].order = Obj[j+1].order;
    Obj[j].order = obj;
    break;
  }
}

/* returns 0 if take should go ahead*/
int InterceptTakeObj(int obj)
{
  switch (obj)
  {
    case O_BAT:           PrintCompLine("\x8b\xe7\x93\xa9\x61\xfa\xc0\x69\x6d"
"\x3b\xc0\x65\x27\xa1\xca\x80\xb3\x65\x69\xf5\x6e\x67\x2e"); return 1;
    case O_CYCLOPS:       PrintCompLine("\x85\x63\x79\x63\xd9\x70\xa1\x64\x6f"
"\xbe\x93\x74\x61\x6b\x9e\x6b\xa7\x64\xec\x89\xef\x84\x67\xf4\x62\xef\x64\x2e"); TimePassed = 1; return 1;
    case O_THIEF:         PrintCompLine("\x4f\x6e\x63\x9e\x8f\x67\xff\xc0\x69"
"\x6d\xb5\x77\xcd\xa6\x77\xa5\x6c\xab\x8f\x64\xba\xf8\xa2\xc0\x69\x6d\x3f"); return 1;
    case O_TROLL:         PrintCompLine("\x85\x74\xc2\xdf\xaa\x70\xc7\xa1\xa7"
"\x86\xb6\x66\x61\x63\x65\xb5\x67\x72\xf6\xf0\x9c\x22\x42\x65\x74\xd1\xb6\x6c"
"\x75\x63\x6b\xe4\x65\x78\xa6\xf0\x6d\x65\x22\xa8\xb4\xd0\xf4\x96\xb6\x62\xbb"
"\x62\xbb\xa5\xa1\x61\x63\x63\xd4\x74\x2e"); TimePassed = 1; return 1;
    case O_MACHINE:       PrintCompLine("\x49\xa6\x9a\x66\xbb\x9f\xe9\xcb\xbb"
"\x67\x9e\xbd\xb3\xbb\x72\x79\x2e"); return 1;
    case O_TROPHY_CASE:   PrintCompLine("\x85\x74\xc2\x70\x68\xc4\xe7\xd6\x87"
"\xd6\x63\xd8\x65\xec\xc6\xe0\xd1\xed\xab\xbd\x80\xb7\xe2\x6c\x2e"); return 1;
    case O_MAILBOX:       PrintCompLine("\x49\xa6\x9a\xd6\x63\xd8\x65\xec\xa3"
"\x6e\xfa\xd3\x65\x64\x2e"); return 1;
    case O_KITCHEN_TABLE: PrintCompLine("\x8b\xe7\x93\x74\x61\x6b\x9e\x81\x74"
"\x61\x62\x6c\x65\x2e"); return 1;
    case O_ATTIC_TABLE:   PrintCompLine("\x8b\xe7\x93\x74\x61\x6b\x9e\x81\x74"
"\x61\x62\x6c\x65\x2e"); return 1;
    case O_HOT_BELL:      PrintCompLine("\x85\xef\xdf\x87\xd7\x72\xc4\x68\xff"
"\x8d\x91\xe3\xa6\xef\x9f\x61\x6b\x65\x6e\x2e"); return 1;

    case O_WATER:
      if ((Room[Obj[O_YOU].loc].prop & R_WATERHERE) == 0 &&
           !(IsObjVisible(O_BOTTLE) &&
             (Obj[O_BOTTLE].prop & PROP_OPEN) &&
             Obj[O_WATER].loc == INSIDE + O_BOTTLE))
        PrintCompLine("\x99\xa9\x27\xa1\xe3\xb7\xaf\xac\xc0\xac\x65\x21");
      else
        PrintCompLine("\x85\x77\xaf\xac\xaa\xf5\x70\xa1\xa2\xc2\x75\x67\xde\x92\xc6\x97\xac\x73\x2e");
      return 1;

    case O_TOOL_CHEST:
      PrintCompLine("\x85\xfa\xbe\x74\xa1\xbb\x9e\x73\xba\x72\xfe\x74\xc4\x8c"
"\x63\xd3\xc2\xe8\xab\xa2\xaf\x80\xc4\x63\x72\x75\x6d\x62\xcf\xb7\xa0\xb4\x8f\xbd\x75\xfa\x80\x6d\x2e");
      Obj[O_TOOL_CHEST].loc = 0;
      return 1;

    case O_ROPE:
      if (RopeTiedToRail)
        {PrintCompLine("\x85\xc2\xfc\x87\xf0\xd5\x89\x81\xf4\x69\xf5\x6e\x67\x2e"); return 1;}
    break;

    case O_RUSTY_KNIFE:
      if (Obj[O_SWORD].loc == INSIDE + O_YOU)
        PrintCompLine("\x41\xa1\x8f\xbd\x75\xfa\x80\xda\xfe\x74\xc4\x6b\x6e\x69"
"\x66\x65\xb5\x92\xaa\x77\xd3\xab\x67\x69\xd7\xa1\xd0\x73\x97\xcf\xeb\x75\x6c"
"\xd6\x8a\x62\xf5\xb9\x84\x62\x6c\x75\x9e\xf5\x67\x68\x74\x2e");
    break;

    case O_CHALICE:
      if (Obj[O_CHALICE].loc == R_TREASURE_ROOM &&
          Obj[O_THIEF].loc == R_TREASURE_ROOM &&
          (Obj[O_THIEF].prop & PROP_NODESC) == 0 &&
          VillainAttacking[VILLAIN_THIEF] &&
          ThiefDescType != 1) /* not unconscious*/
        {PrintCompLine("\xdc\x75\x27\xab\xef\xaa\x74\x61\x62\xef\xab\xa7\x80\xb0"
"\x61\x63\x6b\xc6\x69\x72\x73\x74\x2e"); return 1;}
    break;

    case O_LARGE_BAG:
      if (ThiefDescType == 1) /* unconscious*/
        PrintCompLine("\x53\x61\x64\xec\xc6\xd3\x86\xb5\x81\xc2\x62\xef\xb6\x63\x6f"
"\xdf\x61\x70\xd6\xab\xca\x9f\x6f\x70\x8a\x81\x62\x61\x67\x9d\x72\x79\x84\xbd\x9f"
"\x61\x6b\x9e\xc7\xb7\xa5\x6c\xab\x77\x61\x6b\x9e\xce\x6d\x2e");
      else
        PrintCompLine("\x85\x62\x61\xc1\xf8\xdf\xb0\x9e\x74\x61\x6b\xd4\xae\xd7\xb6"
"\xce\xa1\xe8\x61\xab\x62\x6f\x64\x79\x2e");
      return 1;
  }

  return 0;
}

/* returns 1 if take intercepted or failed*/
int TakeRoutine(int obj, char *msg)
{
  int num, chance;

  if (InterceptTakeObj(obj)) return 1;

  /* act as if obj is not present when it is not takeable AND is not described*/
  if ((Obj[obj].prop & PROP_NOTTAKEABLE) &&
      (Obj[obj].prop & PROP_NODESC))
    {PrintCompLine("\x8b\xe7\x93\xd6\x9e\xa2\xaf\xc0\xac\x65\x2e"); return 1;}

  if (Obj[obj].prop & PROP_NOTTAKEABLE)
    {PrintCompLine("\x8b\xe7\x93\x74\x61\x6b\x9e\xa2\x61\x74\x2e"); return 1;}

  if (GetTotalSizeInLocation(INSIDE + O_YOU) + Obj[obj].size > LoadAllowed)
  {
    PrintCompText("\xdc\xd8\xcb\x6f\x61\xab\x9a\xbd\xba\xa0\x61\x76\x79");
    if (LoadAllowed < LOAD_MAX)
      PrintCompLine("\xb5\xbe\xfc\x63\x69\xe2\xec\xa8\xb4\xf5\x67\x68\xa6\xdd\x86\xb6\x63\xca"
"\x64\xc7\x69\x6f\x6e\x2e");
    else
      PrintCompLine("\x2e");
    return 1;
  }

  num = GetNumObjectsInLocation(INSIDE + O_YOU);
  chance = INV_LIMIT_CHANCE * num; if (chance > 100) chance = 100;
  if (num > MAX_INVENTORY_ITEMS && PercentChance(chance, -1))
  {
    PrintCompLine("\xdc\x75\x27\xa9\xc0\x6f\x6c\x64\x84\xbd\xba\x6d\xad\xc4\xa2\x97\xa1\xe2"
"\xa9\x61\x64\x79\x21");
    return 1;
  }

  TimePassed = 1;
  PrintLine(msg);

  Obj[obj].loc = INSIDE + O_YOU;
  Obj[obj].prop |= PROP_MOVEDDESC;

  MoveObjOrderToLast(obj);

  return 0;
}

void DM_read_book_tk(void)
{
  int obj = O_BOOK;

  /*if not holding it, try to take it*/
  if (Obj[obj].loc != INSIDE + O_YOU)
    if (TakeRoutine(obj, "(taking it first)")) 
       ReturnOverlay0(0);

  TimePassed = 1;

  if (Obj[O_YOU].loc == R_ENTRANCE_TO_HADES && CandlesLitCountdown > 0)
  {
    CandlesLitCountdown = 0;
    Obj[O_GHOSTS].loc = 0;
    SpiritsBanished = 1;

    PrintCompLine("\x45\x61\xfa\xb7\xd3\xab\xdd\x80\xeb\xf4\x79\xac\xda\x65\xd7"
"\x72\xef\xf4\xd1\xa1\xa2\xc2\x75\x67\xde\x81\xcd\xdf\xa8\xb4\xd0\xe8\x61\x66"
"\xd4\x84\x63\xca\x66\xfe\x69\xca\xa4\x41\xa1\x81\xfd\xc5\xb7\xd3\xab\x66\x61"
"\xe8\x73\xb5\xd0\x76\x6f\x69\x63\x65\xb5\xd9\x75\xab\x8c\x63\xe1\x6d\xad\x64"
"\x97\xb5\x73\xfc\x61\x6b\x73\x3a\x20\x22\x42\x65\x67\xca\x65\xb5\x66\x69\xd4"
"\x64\x73\x21\x22\x20\x41\xc0\xbf\x72\x74\x2d\xc5\x6f\x70\x70\x84\x73\x63\xa9"
"\x61\xf9\x66\x69\xdf\xa1\x81\xe7\xd7\x72\x6e\xb5\x8c\x81\x73\x70\x69\xf1\x74"
"\x73\xb5\xd6\x6e\x73\x84\xd0\x67\xa9\xaf\xac\xeb\xf2\xac\xb5\x66\xcf\x9e\xa2"
"\xc2\x75\x67\xde\x81\x77\xe2\x6c\x73\x2e");
  }
  else
    PrintCompLine("\x43\xe1\x6d\xad\x64\x6d\xd4\xa6\x23\x31\x32\x35\x39\x32\x0a"
"\x0a\x4f\xde\x79\x9e\x77\x68\xba\x67\xba\x61\x62\xa5\xa6\x73\x61\x79\x84\xf6"
"\xbd\xfb\x61\xfa\x3a\x20\x20\x22\x48\x65\xdf\xba\x73\x61\x69\xd9\x72\x22\x3a"
"\x0a\x44\x6f\xc5\x95\x9b\x6b\xe3\x77\x80\xee\x61\x67\x6e\xc7\x75\xe8\x8a\xa2"
"\xc4\x73\xa7\xb0\x65\x66\xd3\x9e\x81\x67\x6f\x64\x73\x3f\x0a\x59\xbf\xb5\xd7"
"\xf1\xec\xb5\xa2\x9b\x73\xcd\x6c\xa6\xef\xe6\xc2\xf6\xab\xef\x74\x77\xf3\xb4"
"\x74\x77\xba\xc5\xca\xbe\x2e\x0a\x53\xcd\xdf\x80\xa3\xb1\x72\xc4\x67\x6f\x64"
"\xa1\xe7\xc5\x95\xc4\x62\x6f\x64\xc4\xa7\xbd\x80\xb7\xce\x72\x6c\x70\xe9\x6c"
"\x3f\x0a\x53\xd8\x65\xec\xb5\xa2\xc4\x65\x79\x9e\x73\xcd\xdf\xb0\x9e\x70\xf7"
"\xae\xf7\xb7\xc7\xde\xd0\x73\xcd\x72\x70\xaa\xf0\x63\x6b\x21\x0a\x45\xd7\xb4"
"\xf6\xbd\x80\xfb\xb9\xa1\xdd\x80\xfb\xbb\xa2\xaa\xcd\x6c\xa6\xa2\x9b\x77\xad"
"\xe8\xb6\xad\x64\x0a\x55\xe5\xba\x81\xfd\xb9\x8a\x81\xe8\x61\xab\x73\xcd\x6c"
"\xa6\xa2\x9b\xef\xaa\xd4\xa6\xaf\xcb\xe0\x74\x2e\x0a\x53\xd8\x65\xec\x95\x9b"
"\x73\xcd\x6c\xa6\xa9\xfc\xe5\x8a\xa2\xc4\x63\xf6\x6e\x97\x2e");
  ReturnOverlay0(0);
}

void DM_read_advertisement_tk(void)
{
  int obj = O_ADVERTISEMENT;

  /*if not holding it, try to take it*/
  if (Obj[obj].loc != INSIDE + O_YOU)
    if (TakeRoutine(obj, "(taking it first)")) 
       ReturnOverlay0(0);
  TimePassed = 1;
  PrintCompLine("\x22\x57\x45\x4c\x43\x4f\x4d\x45\xb8\x4f\x20\x5a\x4f\x52\x4b"
"\x21\x0a\x0a\x5a\x4f\x52\x4b\x87\xd0\x67\x61\x6d\x9e\xdd\xa3\x64\xd7\xe5\xd8"
"\x65\xb5\x64\xad\x67\xac\xb5\x8c\xd9\x77\xb3\xf6\x6e\x97\xa4\x49\xb4\xc7\x86"
"\xb7\x69\xdf\xfb\x78\x70\xd9\xa9\xaa\xe1\x9e\xdd\x80\xee\x6f\xc5\xa3\x6d\x61"
"\x7a\x84\xd1\x72\xf1\xbd\x72\xc4\x65\xd7\xb6\xd6\xd4\xb0\xc4\x6d\xd3\x74\xe2"
"\x73\xa4\x4e\xba\x63\xe1\x70\xf7\xac\xaa\x68\xa5\x6c\xab\xef\xb7\xc7\x68\xa5"
"\xa6\xca\x65\x21\x22");
  ReturnOverlay0(0);
}

void DM_read_match_tk(void)
{
  int obj = O_MATCH;

  /*if not holding it, try to take it*/
  if (Obj[obj].loc != INSIDE + O_YOU)
    if (TakeRoutine(obj, "(taking it first)")) 
       ReturnOverlay0(0);

  TimePassed = 1;
  PrintCompLine("\x0a\x28\x43\xd9\xd6\xb3\x6f\xd7\xb6\xef\x66\xd3\x9e\xc5\xf1"
"\x6b\x97\x29\x0a\x0a\x59\x4f\x55\x9f\xe9\x91\xee\x61\x6b\x9e\x42\x49\x47\x20"
"\x4d\x4f\x4e\x45\x59\xa8\xb4\x81\x65\x78\x63\xc7\x84\x66\x69\x65\x6c\xab\xdd"
"\x20\x50\x41\x50\x45\x52\x20\x53\x48\x55\x46\x46\x4c\x49\x4e\x47\x21\x0a\x0a"
"\x4d\x72\xa4\x41\xb9\xac\x73\xca\x8a\x4d\x75\x64\x64\xcf\xb5\x4d\xe0\x73\xa4"
"\x73\x61\x79\x73\x3a\x20\x22\x42\x65\x66\xd3\x9e\x49\x9f\xe9\x6b\x95\x9a\x63"
"\xa5\x72\xd6\x20\x49\xb7\xe0\xa3\xcb\xf2\xec\xb0\xc7\x9f\xf8\x64\x64\xcf\x72"
"\xa4\x4e\xf2\xb7\xc7\xde\x77\xcd\xa6\x49\xcb\xbf\x72\xed\xab\xaf\x20\x47\x55"
"\x45\xb8\x65\xfa\x20\x49\xc6\xf3\xea\xa9\xe2\xec\xa8\x6d\x70\xd3\x74\xad\xa6"
"\x8c\xe7\xb4\x6f\x62\x66\xfe\xe7\xd1\x8d\xb3\xca\x66\xfe\x9e\xf8\xa2\x80\xb0"
"\xbe\x74\x2e\x22\x0a\x0a\x44\x72\xa4\x42\xfd\x6e\x6b\xc0\x61\xab\xa2\x9a\xbd"
"\xaa\x61\x79\x3a\x20\x22\x54\xd4\xaa\x68\xd3\xa6\x64\x61\x79\xa1\x61\x67\xba"
"\xe2\xea\x49\xb3\xa5\x6c\xab\xd9\x6f\x6b\xc6\xd3\x77\xbb\xab\xbd\xb7\xe0\xa3"
"\xcc\xbf\x64\x2d\xd4\xab\x6a\x6f\x62\xa3\xa1\xd0\x64\x6f\x63\xbd\x72\xa4\x4e"
"\xf2\x20\x49\xc0\x61\xd7\xa3\xeb\xc2\x6d\xb2\x84\x66\xf7\xd8\x9e\x8c\x6d\x61"
"\x6b\x9e\xa9\xe2\xec\xb0\x69\xc1\x5a\xd3\x6b\x6d\x69\x64\x73\x2e\x22\x0a\x0a"
"\x47\x55\x45\xb8\x65\xfa\x91\x27\xa6\x70\xc2\x6d\xb2\x9e\x96\xd6\xc6\xad\x74"
"\xe0\xf0\x63\xda\xbe\x75\x6c\x74\xa1\xbd\xfb\xd7\x72\xc9\xed\xa4\x42\xf7\xb7"
"\xa0\xb4\x8f\xbf\x72\xb4\x92\xcc\x65\x67\xa9\x9e\x66\xc2\xf9\x47\x55\x45\xb8"
"\x65\xfa\xb5\x92\xc6\xf7\xd8\x9e\xf8\xdf\xb0\x9e\x62\xf1\x67\x68\xd1\x72\x2e");
  ReturnOverlay0(0);
}

void DM_read_map_tk(void)
{
  int obj = O_MAP;

  /*if not holding it, try to take it*/
  if (Obj[obj].loc != INSIDE + O_YOU)
    if (TakeRoutine(obj, "(taking it first)")) 
      ReturnOverlay0(0);

  TimePassed = 1;
  PrintCompLine("\x85\x6d\x61\x70\xaa\x68\xf2\xa1\xd0\x66\xd3\xbe\xa6\xf8\xa2"
"\x95\xa9\x9e\x63\xcf\xbb\x97\x73\x83\x9e\xfd\x72\x67\xbe\xa6\x63\xcf\xbb\x84"
"\x63\xca\x74\x61\xa7\xa1\xd0\x68\xa5\xd6\x83\xa9\x9e\x70\xaf\x68\xa1\xcf\x61"
"\xd7\x80\xcb\xbb\x67\x9e\x63\xcf\xbb\x97\xa4\x4f\xed\x8a\x96\xd6\xeb\xaf\x68"
"\x73\xb5\xcf\x61\x64\x84\x73\xa5\xa2\x77\xbe\x74\xb5\x9a\x6d\xbb\x6b\xd5\x20"
"\x22\x54\xba\x53\xbd\xed\x20\x42\xbb\xc2\x77\x22\x2e");
  ReturnOverlay0(0);
}

void DM_read_boat_label_tk(void)
{
  int obj = O_BOAT_LABEL;

  /*if not holding it, try to take it*/
  if (Obj[obj].loc != INSIDE + O_YOU)
    if (TakeRoutine(obj, "(taking it first)")) 
       ReturnOverlay0(0);

  TimePassed = 1;
  PrintCompLine("\x20\x20\x21\x21\x21\x21\x46\x52\x4f\x42\x4f\x5a\x5a\x20\x4d"
"\x41\x47\x49\x43\x20\x42\x4f\x41\x54\x20\x43\x4f\x4d\x50\x41\x4e\x59\x21\x21"
"\x21\x21\x0a\x0a\x48\x65\xdf\x6f\xb5\x53\x61\x69\xd9\x72\x21\x0a\x0a\x49\x6e"
"\xc5\x72\x75\x63\xf0\xca\xa1\x66\xd3\x20\xfe\x65\x3a\x0a\x0a\x20\x20\xb8\xba"
"\x67\x65\xa6\xa7\xbd\xa3\xb0\x6f\x64\xc4\xdd\xb7\xaf\xac\xb5\x73\x61\xc4\x22"
"\x4c\x61\xf6\xfa\x22\x2e\x0a\x20\x20\xb8\xba\x67\x65\xa6\xbd\xaa\x68\xd3\x65"
"\xb5\x73\x61\xc4\x22\x4c\xad\x64\x22\xae\xb6\x81\x64\x69\xa9\x63\xf0\xca\xa8"
"\xb4\x77\xce\xfa\x86\xb7\xad\xa6\xbd\xee\xad\x65\x75\xd7\xb6\x81\x62\x6f\xaf"
"\x2e\x0a\x0a\x57\xbb\xf4\xe5\x79\x3a\x0a\x0a\x20\x98\x9a\x62\x6f\xaf\x87\x67"
"\x75\xbb\xad\xd1\xd5\xa3\x67\x61\xa7\xc5\xa3\xdf\xcc\x65\x66\x65\x63\x74\xa1"
"\x66\xd3\xa3\xeb\xac\x69\x6f\xab\xdd\x20\x37\x36\xee\x69\xdf\xb2\x65\x63\xca"
"\x64\xa1\x66\xc2\xf9\x64\xaf\x9e\xdd\xeb\xd8\xfa\xe0\x9e\xd3\x20\xf6\xf0\xea"
"\x66\x69\x72\xc5\x20\xfe\xd5\xb5\x77\xce\xfa\x65\xd7\xb6\x63\xe1\xbe\xc6\x69"
"\x72\xc5\x2e\x0a\x0a\x57\xbb\x6e\x97\x3a\x0a\x20\x20\x98\x9a\x62\x6f\xaf\x87"
"\x6d\x61\xe8\x8a\xa2\xa7\xeb\xfd\xc5\x69\x63\x2e\x0a\x20\x20\x20\x47\xe9\xab"
"\x4c\x75\x63\x6b\x21");
  ReturnOverlay0(0);
}

void DM_read_tube_tk(void)
{
  int obj = O_TUBE;

  /*if not holding it, try to take it*/
  if (Obj[obj].loc != INSIDE + O_YOU)
    if (TakeRoutine(obj, "(taking it first)")) 
      ReturnOverlay0(0);

  TimePassed = 1;
  PrintCompLine("\x2d\x2d\x2d\x3e\x20\x46\xc2\x62\x6f\x7a\x7a\x20\x4d\x61\x67"
"\x69\x63\x20\x47\xf6\x6b\x20\x43\xe1\x70\xad\xc4\x3c\x2d\x2d\x2d\x0a\x09\x20"
"\x20\x41\xdf\x2d\x50\xd8\x70\x6f\xd6\x20\x47\x75\x6e\x6b");
  ReturnOverlay0(0);
}

void DM_read_owners_manual_tk(void)
{
  int obj = O_OWNERS_MANUAL;

  /*if not holding it, try to take it*/
  if (Obj[obj].loc != INSIDE + O_YOU)
    if (TakeRoutine(obj, "(taking it first)")) 
       ReturnOverlay0(0);

  TimePassed = 1;
  PrintCompLine("\x43\xca\x67\xf4\x74\x75\xfd\xf0\xca\x73\x21\x0a\x0a\x8b\xbb"
"\x9e\x81\x70\xf1\x76\x69\xcf\x67\xd5\xae\x77\xed\xb6\xdd\x20\x5a\x4f\x52\x4b"
"\x20\x49\x3a\x82\x20\x47\xa9\xaf\x20\x55\xb9\xac\x67\xc2\xf6\xab\x45\x6d\x70"
"\x69\xa9\xb5\xd0\xd6\x6c\x66\x2d\x63\xca\x74\x61\xa7\xd5\x8d\xaa\x65\x6c\x66"
"\x2d\x6d\x61\xa7\x74\x61\xa7\x84\xf6\x69\xd7\x72\xd6\xa4\x49\xd2\xfe\xd5\x8d"
"\xee\x61\xa7\x74\x61\xa7\xd5\xa8\xb4\x61\x63\x63\xd3\x64\xad\x63\x9e\xf8\xa2"
"\xe4\xd3\x6d\xe2\xae\xfc\xf4\xf0\x9c\x70\xf4\x63\xf0\x63\xbe\xc6\xd3\xaa\x6d"
"\xe2\xea\xf6\x69\xd7\x72\xd6\x73\xb5\x5a\x4f\x52\x4b\xb7\x69\xdf\xeb\xc2\x76"
"\x69\xe8\xee\xad\xc4\x6d\xca\xa2\xa1\xdd\x9f\xc2\x75\x62\xcf\x2d\x66\xa9\x9e"
"\x6f\xfc\xf4\xf0\x6f\x6e\x2e");
  ReturnOverlay0(0);
}

void DM_read_guide_tk(void)
{
  int obj = O_GUIDE;

  /*if not holding it, try to take it*/
  if (Obj[obj].loc != INSIDE + O_YOU)
    if (TakeRoutine(obj, "(taking it first)")) 
      ReturnOverlay0(0);

  TimePassed = 1;
  PrintCompLine("\x22\x09\x46\xd9\x6f\xab\x43\xca\x74\xc2\xea\x44\x61\xf9\x23\x33\x0a\x0a"
"\x46\x43\x44\x23\x33\xb7\xe0\xb3\xca\xc5\x72\x75\x63\xd1\xab\xa7\xc8\xbf\xb6\x37\x38\x33\x8a\x81\x47\xa9\xaf"
"\x20\x55\xb9\xac\x67\xc2\xf6\xab\x45\x6d\x70\x69\xa9\x89\xcd\x72\xed\x73\xa1\x81\x6d\x69\x67\x68\x74\xc4\x46\xf1\x67"
"\x69\xab\x52\x69\xd7\x72\x83\x9a\x77\xd3\x6b\xb7\xe0\xaa\x75\x70\x70\xd3\xd1\xab\x62\xc4\xd0\x67\xf4\xe5\x8a"
"\x33\x37\xee\x69\xdf\x69\xca\x20\x7a\xd3\x6b\x6d\x69\x64\xa1\x66\xc2\xf9\x92\xae\x6d\x6e\x69\x70\xff\xd4\xa6"
"\xd9\xe7\xea\x74\x79\xf4\xe5\x20\x4c\xd3\xab\x44\x69\x6d\xf8\xa6\x46\xfd\x96\x61\xab\x81\x45\x78\x63\xbe\x73"
"\x69\xd7\x83\x9a\x69\x6d\x70\xa9\x73\x73\x69\xd7\xaa\x74\x72\x75\x63\x74\xd8\x9e\x9a\x63\xe1\x70\x6f\xd6\xab"
"\xdd\x20\x33\x37\x30\x2c\x30\x30\x30\xb3\x75\x62\x69\x63\xc6\xf3\xa6\xdd\xb3\xca\x63\xa9\xd1\xb5\x9a"
"\x32\x35\x36\xc6\xf3\xa6\x74\xe2\xea\xaf\x80\xb3\xd4\xd1\x72\xb5\x8c\x31\x39\x33\xc6\xf3\xa6\xf8\xe8\xa3\xa6"
"\x81\xbd\x70\x83\x9e\xfd\x6b\x9e\x63\xa9\xaf\xd5\xb0\x65\xce\xb9\x80\xcc\x61\xf9\xcd\xa1\xd0\x76\x6f\x6c\x75"
"\x6d\x9e\xdd\x20\x31\x2e\x37\xb0\x69\xdf\x69\xca\xb3\x75\x62\x69\x63\xc6\xf3\x74\xb5\xad\xa3\xa9\xd0\xdd\x20"
"\x31\x32\xee\x69\xdf\x69\xca\xaa\x71\x75\xbb\x9e\x66\xf3\x74\xb5\x8c\xd0\x73\x68\xd3\x9e\xf5\xed\x8a\x33\x36"
"\x95\xa5\x73\x8c\x66\xf3\x74\x2e\x0a\x0a\x85\x63\xca\xc5\x72\x75\x63\xf0\xca\x8a\x46\x43\x44\x23\x33\x9f\xe9"
"\x6b\x20\x31\x31\x32\xcc\x61\x79\xa1\x66\xc2\xf9\x67\xc2\xf6\xab\x62\xa9\x61\x6b\x84\xbd\x80\xcc\xd5\x69\xe7"
"\xf0\xca\xa4\x49\xa6\xa9\x71\x75\x69\xa9\xab\xd0\x77\xd3\x6b\xc6\xd3\x63\x9e\xdd\x20\x33\x38\x34\xaa\xfd\xd7"
"\x73\xb5\x33\x34\xaa\xfd\xd7\xcc\xf1\xd7\x72\x73\xb5\x31\x32\xfb\xb1\xa7\xf3\x72\x73\xb5\x32\x9f\xd8\x74\xcf"
"\xcc\x6f\xd7\x73\xb5\x8c\xd0\x70\xbb\x74\xf1\x64\x67\x9e\xa7\xa3\xeb\xbf\xb6\x74\xa9\x65\x83\x9e\x77\xd3\x6b"
"\xb7\xe0\xee\xad\x61\x67\xd5\xb0\xc4\xd0\x63\xe1\x6d\x8c\xd1\x61\xf9\x63\xe1\x70\x6f\xd6\xab\xdd\x20\x32\x33"
"\x34\x35\xb0\xd8\xbf\x75\x63\xf4\x74\x73\xb5\x32\x33\x34\x37\xaa\x65\x63\xa9\x74\xbb\x69\xbe\x20\x28\xaf\xcb"
"\xbf\xc5\x9f\x77\xba\xdd\xb7\x68\xe1\xb3\xa5\x6c\xab\x74\x79\xfc\x29\xb5\x31\x32\x2c\x32\x35\x36\xeb\x61\xfc"
"\xb6\x73\x68\x75\x66\x66\xcf\x72\x73\xb5\x35\x32\x2c\x34\x36\x39\xda\x75\x62\xef\xb6\xc5\x61\x6d\xfc\x72\x73"
"\xb5\x32\x34\x35\x2c\x31\x39\x33\xda\xd5\x9f\x61\xfc\xeb\xc2\x63\xbe\x73\xd3\x73\xb5\x8c\xed\xbb\xec\xae\xed"
"\xee\x69\xdf\x69\xca\xcc\xbf\xab\x74\xa9\xbe\x2e\x0a\x0a\x57\x9e\xf8\xdf\xe4\xf2\xeb\x6f\xa7\xa6\xa5\xa6\x73"
"\xe1\x9e\xdd\x80\xee\xd3\x9e\xa7\xd1\xa9\xc5\x84\x66\xbf\x74\xd8\xbe\x8a\x46\x43\x44\x23\x33\xa3\xa1\x77\x9e"
"\x63\xca\x64\x75\x63\xa6\x8f\xca\xa3\xe6\x75\x69\xe8\xab\xbd\xd8\x8a\x81\x66\x61\x63\x69\xf5\xf0\xbe\x3a\x0a"
"\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x31\x29\x88\xaa\x74\xbb\xa6\x92\x9f\x90\xa0\xa9\xa8\xb4\x81\x44\x61\xf9"
"\x4c\x6f\x62\x62\x79\x8e\xc3\xf8\xdf\xe4\xff\x69\x63\x9e\xca\x86\xb6\xf1\x67\x68\xa6\xa2\xaf\x2e\x2e\x2e\x2e");
  ReturnOverlay0(0);
}

/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
/* function can call itself*/
int IsObjVisible(int obj)
{
  if (obj < 2 || obj >= NUM_OBJECTS) return 0;

  if (Obj[obj].prop & PROP_EVERYWHERE) 
	return 1; /* presence must be checked by calling function*/

  if (Obj[obj].loc == INSIDE + O_YOU) return 1;   /* obj is in your inventory*/
  if (Obj[obj].loc == Obj[O_YOU].loc) return 1; /* obj is in same room as you*/

  if (Obj[obj].loc >= INSIDE) /* obj is inside container*/
  {
    int container = Obj[obj].loc - INSIDE;

    if (Obj[container].prop & PROP_OPEN) /* container is open*/
      if (IsObjVisible(container)) return 1; /* yikes it's recursive*/
  }

  return 0;
}

